name: Integration Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Install crun
        run: |
          sudo apt-get update
          sudo apt-get install -y crun
          
      - name: Install Nomad
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install nomad
          
      - name: Build Plugin
        run: make build
          
      - name: Build Test Artifacts
        run: make test-artifacts
        
      - name: Run Unit Tests
        run: make test
        
      - name: Run Integration Tests
        run: |
          # Start Nomad in dev mode with our plugin
          sudo nomad agent -dev -plugin-dir=/tmp/nomad-plugins -log-level=INFO &
          NOMAD_PID=$!
          
          # Wait for Nomad to be ready
          sleep 10
          nomad node status
          
          # Run integration tests
          make test-integration
          
          # Stop Nomad
          sudo kill $NOMAD_PID || true